@using ZauberCMS.Core.Content.Commands
@implements ZauberCMS.Core.Sections.Interfaces.ISectionDashboard

<RadzenDataGrid AllowFiltering="false"
                FilterPopupRenderMode="PopupRenderMode.OnDemand"
                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                AllowPaging="false"
                PageSize="20"
                AllowSorting="true"
                Data="@Contents"
                SelectionMode="DataGridSelectionMode.Single"
                RowSelect="@((Content value) => OnRowSelect(value))">
    @*@bind-Value="@SelectedContent"*@
    <Columns>
        <RadzenDataGridColumn Property="Name" Title="Name"/>
        <RadzenDataGridColumn Property="DateUpdated" Title="Last Updated">
            <Template Context="data">
                @data.DateUpdated.Humanize()
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    public string TabName => "Latest Content";
    public int SortOrder => 0;
    public string SectionAlias => Constants.Sections.ContentSection;
    
    private IEnumerable<Content> Contents { get; set; } = Enumerable.Empty<Content>();

    [Parameter] public Guid? ParentId { get; set; }
    [Parameter] public int AmountPerPage { get; set; } = 20;
    [Parameter] public bool RefreshPage { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        var queryContentCommand = new QueryContentCommand
        {
            AmountPerPage = AmountPerPage,
            OrderBy = GetContentsOrderBy.DateUpdatedDescending
        };
        if (ParentId != null)
        {
            queryContentCommand.ParentId = ParentId;
        }
        var items = await Mediator.Send(queryContentCommand);
        Contents = items.Items;
    }

    private void OnRowSelect(object value)
    {
        if (value is Content selectedRow)
        {
            NavigationManager.NavigateTo($"/admin/updatecontent/{selectedRow.Id}", RefreshPage);
        }
    }
}