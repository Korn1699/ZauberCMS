@using ZauberCMS.Core.Content.Commands
@implements ZauberCMS.Core.Sections.Interfaces.ISectionDashboard



<RadzenDataGrid AllowFiltering="true"
                FilterPopupRenderMode="PopupRenderMode.Initial"
                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                AllowPaging="true"
                PageSize="@AmountPerPage"
                AllowSorting="true"
                LoadData="@LoadData"
                IsLoading="@IsLoading"
                Count="@Count"
                Data="@Contents"
                SelectionMode="DataGridSelectionMode.Single"
                RowSelect="@((Content value) => OnRowSelect(value))"
                PagerHorizontalAlign="HorizontalAlign.Center">
    @*@bind-Value="@SelectedContent"*@
    <Columns>
        <RadzenDataGridColumn Property="Name" Title="Name"/>
        <RadzenDataGridColumn Property="DateUpdated" Title="Last Updated">
            <Template Context="data">
                @data.DateUpdated.Humanize()
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn Property="LastUpdatedBy" Title="Updated By">
            <Template Context="data">
                <RadzenGravatar Email="@data.LastUpdatedBy?.Email" Style="width: 25px; height: 25px;"/>
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    [Parameter] public Guid? ParentId { get; set; }
    [Parameter] public int AmountPerPage { get; set; } = 20;
    [Parameter] public bool RefreshPage { get; set; }
    
    public string TabName => "Latest Content";
    public int SortOrder => 0;
    public string SectionAlias => Constants.Sections.ContentSection;
    
    private int Count { get; set; } 
    private bool IsLoading { get; set; } = false;
    private IEnumerable<Content> Contents { get; set; } = [];

    async Task LoadData(LoadDataArgs args)
    {
        IsLoading = true;

        await Task.Yield();

        var command = new DataGridContentCommand();

        if (ParentId != null)
        {
            command.ParentId = ParentId;
        }
        
        if (args.Top != null)
        {
            command.Take = args.Top.Value;
        }

        if (args.Skip != null)
        {
            command.Skip = args.Skip.Value;
        }

        if (!string.IsNullOrEmpty(args.Filter))
        {
            // Filter via the Where method
            command.Filter = args.Filter;
        }

        if (!string.IsNullOrEmpty(args.OrderBy))
        {
            // Sort via the OrderBy method
            command.Order = args.OrderBy;
        }

        var result = await Mediator.Send(command);
        Count = result.Count;
        Contents = result.Items;

        IsLoading = false;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData(new LoadDataArgs {Top = AmountPerPage});
    }

    private void OnRowSelect(object value)
    {
        if (value is Content selectedRow)
        {
            NavigationManager.NavigateTo($"/admin/updatecontent/{selectedRow.Id}", RefreshPage);
        }
    }

}