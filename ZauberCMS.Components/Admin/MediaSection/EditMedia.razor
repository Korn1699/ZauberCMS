@using ZauberCMS.Core.Media.Models
@using ZauberCMS.Core
@using ZauberCMS.Core.Media.Commands
@page "/admin/createmedia"
@page "/admin/createfolder"
@page "/admin/createmedia/{ParentId:guid}"
@page "/admin/createfolder/{ParentId:guid}"
@page "/admin/updatemedia/{MediaId:guid}"
@layout SectionLayout

<PageTitle>Create & Update Content</PageTitle>

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Right" Gap="5" Style="margin-top: 0; padding-top: 0; padding-bottom: 10px;">
    <CreateMedia ParentId="ParentId" />
</RadzenStack>

@if (Media != null)
{
    <RadzenPanel Class="rz-mx-auto">
        @if (UpdateType == MediaUpdateType.Folder)
        {
            <EditForm Model="@Media" OnSubmit="Save">
                <RadzenRow class="rz-pb-6">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Left" AlignItems="AlignItems.Center" class="w-100" Gap="2">
                        <RadzenTextBox Style="width: 100%;" Name="Name" Placeholder="Name" @bind-Value="Media.Name" aria-label="Name"/>
                    </RadzenStack>
                </RadzenRow>
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Right" AlignItems="AlignItems.Center">
                    <RadzenButton ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Success" Icon="save" Text="Save"/>
                </RadzenStack>
            </EditForm>    
        }
        else
        {
            <MediaUpload ParentId="@ParentId" />
        }
    </RadzenPanel>   
}

@code {
    [Parameter] public Guid? MediaId { get; set; }
    [Parameter] public Guid? ParentId { get; set; }

    [Inject] NotificationService NotificationService { get; set; } = default!;
    
    [CascadingParameter] protected SectionLayout? Layout { get; set; }

    private Media? Media { get; set; }
    private MediaUpdateType UpdateType { get; set; } = MediaUpdateType.Folder;
    
    protected override void OnInitialized()
    {
        if (NavigationManager.Uri.Contains("media", StringComparison.OrdinalIgnoreCase))
        {
            UpdateType = MediaUpdateType.Media;
        }
        Layout?.SetSection(Constants.Sections.MediaSection);
        if (MediaId.HasValue)
        {
            // TODO
        }
        else
        {
            Media = new Media();
            if (UpdateType == MediaUpdateType.Folder)
            {
                Media.MediaType = MediaType.Folder;
            }
        }
    }

    private static string GetCompositeKey(Guid? mediaId, Guid? parentId)
    {
        return $"{mediaId?.ToString() ?? "null"}_{parentId?.ToString() ?? "null"}";
    }
    
    private async Task Save()
    {
        if (UpdateType == MediaUpdateType.Folder)
        {
            var saveCommand = new SaveMediaCommand { ParentFolderId = ParentId};
            saveCommand.MediaToSave.Add(Media!);
            var result = await Mediator.Send(saveCommand);
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Saved", Detail = "", Duration = 4000 });
        }
    }

    private enum MediaUpdateType
    {
        Folder,
        Media
    }

}