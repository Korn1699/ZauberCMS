@page "/admin/settings/languages"
@using ZauberCMS.Core.Data.Commands
@using ZauberCMS.Core.Languages.Models
@layout SectionLayout

<PageTitle>Languages</PageTitle>

<RadzenDataGrid AllowFiltering="true"
                FilterPopupRenderMode="PopupRenderMode.Initial"
                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                AllowPaging="true"
                PageSize="@AmountPerPage"
                AllowSorting="true"
                LoadData="@LoadData"
                IsLoading="@IsLoading"
                Count="@Count"
                Data="@AllLanguages"
                SelectionMode="DataGridSelectionMode.Single"
                RowSelect="@((Language value) => OnRowSelect(value))"
                PagerHorizontalAlign="HorizontalAlign.Center">
    
    <Columns>
        <RadzenDataGridColumn Property="LanguageCultureName" Title="Name"/>
        <RadzenDataGridColumn Property="LanguageIsoCode" Title="ISO Code"/>
        <RadzenDataGridColumn Property="DateCreated" Title="Created">
            <Template Context="data">
                @data.DateCreated.Humanize()
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    [Inject] public IModalService DialogService { get; set; } = default!;
    
    [Parameter] public int AmountPerPage { get; set; } = 20;
    [Parameter] public bool RefreshPage { get; set; }
    
    [CascadingParameter] protected SectionLayout? Layout { get; set; }
    
    private IEnumerable<Language> AllLanguages { get; set; } = [];
    private int Count { get; set; } 
    private bool IsLoading { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        Layout?.SetSection(Constants.Sections.SettingsSection);
        await LoadData(new LoadDataArgs {Top = AmountPerPage});
    }
    
    async Task LoadData(LoadDataArgs args)
    {
        IsLoading = true;

        await Task.Yield();

        var command = new DataGridCommand<Language>();
        
        if (args.Top != null)
        {
            command.Take = args.Top.Value;
        }

        if (args.Skip != null)
        {
            command.Skip = args.Skip.Value;
        }

        if (!string.IsNullOrEmpty(args.Filter))
        {
            // Filter via the Where method
            command.Filter = args.Filter;
        }

        // Sort via the OrderBy method
        command.OrderBy = !string.IsNullOrEmpty(args.OrderBy) ? args.OrderBy : "DateCreated desc";

        var result = await Mediator.Send(command);
        Count = result.Count;
        AllLanguages = result.Items;

        IsLoading = false;
    }
    
    private async Task OnRowSelect(object value)
    {
        if (value is Language selectedRow)
        {
            var dialog = DialogService.OpenSidePanel<CreateLanguage>("Create Language", new Dictionary<string, object>
            {
                { "Language", selectedRow }
            });
            var result = await dialog.Result;
            if (result is { Confirmed: true })
            {
                await LoadData(new LoadDataArgs {Top = AmountPerPage});      
            }
        }
    }
}