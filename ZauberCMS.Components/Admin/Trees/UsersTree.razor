@using ZauberCMS.Core.Membership.Models

<BaseTree
    T="UsersTreeStub"
    Data="@Data"
    OnExpand="@OnExpandHandler"
    OnChange="@OnChangeHandler"
    OnItemContextMenu="@OnItemContextMenuHandler"
    @bind-Value="@Value"
    HasChildren="@(e => HasChildren(e))"
    ShouldBeExpanded="@(e => ShouldBeExpanded(e))"
    Template="@(CreateTreeTemplate<object>())">
</BaseTree>

@code {
    [Parameter] public IEnumerable<UsersTreeStub> Data { get; set; } = [];
    [Parameter] public EventCallback<TreeExpandEventArgs> OnExpand { get; set; }
    [Parameter] public EventCallback OnChange { get; set; }
    [Parameter] public EventCallback<TreeItemContextMenuEventArgs> OnItemContextMenu { get; set; }
    [Parameter] public object? Value { get; set; }
    [Parameter] public EventCallback<object> ValueChanged { get; set; }

    private RadzenTree Tree { get; set; } = default!;
    
    protected override void OnParametersSet()
    {
        if (!Data.Any())
        {
            var tree = new List<UsersTreeStub>();
            var usersTree = new UsersTreeStub
            {
                Name = "Users",
                Icon = "people",
                SortOrder = 1
            };
            var rolesTree = new UsersTreeStub
            {
                Name = "Roles",
                Icon = "person_add",
                SortOrder = 2
            };
            tree.Add(usersTree);
            tree.Add(rolesTree);
            Data = tree;
        }
    }

    private async Task OnExpandHandler(TreeExpandEventArgs args)
    {
        if (OnExpand.HasDelegate)
        {
            await OnExpand.InvokeAsync(args);
        }
        else
        {
            /*switch (args.Value)
            {
                case UsersTreeStub treeStub:
                    /*var items = Mediator.Send(new QueryContentCommand
                {
                    WhereClause = x => x.ParentId == category.Id,
                    OrderBy = GetContentsOrderBy.SortOrder
                }).GetAwaiter().GetResult();
                args.Children.Data = items.Items;
                args.Children.TextProperty = "Name";
                args.Children.Template = CreateTreeTemplate<RadzenTreeItem>();#1#
                    break;
                case UsersTreeBranch branch:
                    break;
            }*/
        }
    }


    private RenderFragment<T> CreateTreeTemplate<T>() where T : class
    {
        return context => builder =>
        {
            var treeItem = context as RadzenTreeItem;
            builder.OpenComponent<RadzenIcon>(0);
            switch (treeItem?.Value)
            {
                case UsersTreeStub treeStub:
                    builder.AddAttribute(1, "Icon", treeStub.Icon);
                    builder.AddAttribute(2, "style", "font-weight: 300; color: dimgray;");
                    builder.CloseComponent();
                    builder.AddContent(3, treeStub.Name);
                    break;
                case UsersTreeBranch branch:
                    builder.AddAttribute(1, "Icon", branch.Icon);
                    builder.AddAttribute(2, "style", "font-weight: 300; color: dimgray;");
                    builder.CloseComponent();
                    builder.AddContent(3, branch.Name);
                    break;
            }
        };
    }

    private async Task OnChangeHandler()
    {
        await ValueChanged.InvokeAsync(Value);
        if (OnChange.HasDelegate)
        {
            await OnChange.InvokeAsync();
        }
    }

    private async Task OnItemContextMenuHandler(TreeItemContextMenuEventArgs args)
    {
        if (OnItemContextMenu.HasDelegate)
        {
            await OnItemContextMenu.InvokeAsync(args);
        }
    }

    private bool HasChildren(object data)
    {
        return data switch
        {
            UsersTreeStub tree => tree.Branches.Any(),
            UsersTreeBranch branch => branch.Branches.Any(),
            _ => false
        };
    }

    private bool ShouldBeExpanded(object data)
    {
        return data switch
        {
            UsersTreeStub tree => tree.Branches.Any(),
            _ => false
        };
    }

}