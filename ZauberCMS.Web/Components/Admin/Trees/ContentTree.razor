@using ZauberCMS.Core
@using ZauberCMS.Core.Content.Commands
@using ZauberCMS.Core.Shared
@using Content = ZauberCMS.Core.Content.Models.Content
@implements ZauberCMS.Core.Sections.Interfaces.ISectionNav

<RadzenTree @ref="Tree" Data="@ContentItems" Expand="@OnExpand" Change="@OnChange" @bind-Value="@Selection" ItemContextMenu="ItemContextMenu">
    <RadzenTreeLevel Expanded="@ShouldBeExpanded" HasChildren="@(e => HasChildren(e))" TextProperty="Name">
        <Template>
            @{ var content = context.Value as Content; }
            @if (content?.ContentType?.Icon.IsNullOrWhiteSpace() == false)
            {
                <RadzenIcon Icon="@content.ContentType.Icon" style="font-weight: 300; color: dimgray;"/>
            }
            @content?.Name
        </Template>
    </RadzenTreeLevel>
</RadzenTree>

@code {
    public string Heading => "Content";
    public int SortOrder => 0;
    public string SectionAlias => Constants.Sections.ContentSection;
    
    [Inject] public IServiceProvider ServiceProvider { get; set; } = default!;
    [Inject] public ContextMenuService ContextMenuService { get; set; } = default!;
    [Inject] public NotificationService NotificationService { get; set; } = default!;
    [Inject] public DialogService DialogService { get; set; } = default!;
    [Inject] public AppState AppState { get; set; } = default!;
    
    private List<Content> ContentItems { get; set; } = [];
    private object? Selection { get; set; }
    private RadzenTree Tree { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        // Get all section nav items
        
        await DataRefresh();
        AppState.OnContentChanged += HandleContentTreeChanged;
    }

    public void Dispose()
    {
        AppState.OnContentChanged -= HandleContentTreeChanged;
    }
    
    private async Task HandleContentTreeChanged()
    {
        // Your custom logic here
        await DataRefresh();
        
        // Call StateHasChanged to refresh the component
        StateHasChanged();
    }
    
    private async Task DataRefresh()
    {
        var items = await Mediator.Send(new GetContentsCommand
        {
            AmountPerPage = 1000,
            WhereClause = x => x.IsRootContent
        });
        ContentItems = items.Items.ToList();
    }

    private bool HasChildren(object data)
    {
        if (data is Content content)
        {
            var items = Mediator.Send(new GetContentsCommand
            {
                AsNoTracking = true,
                WhereClause = x => x.ParentId == content.Id
            }).GetAwaiter().GetResult();
            return items.Items.Any();
        }
        return false;
    }

    private bool ShouldBeExpanded(object data)
    {
        if (data is Content content)
        {
            return HasChildren(content) && content.ParentId == null;
        }

        return false;
    }
    
    private void ItemContextMenu(TreeItemContextMenuEventArgs args)
    { 
        ContextMenuService.Open(args,
            new List<ContextMenuItem> {
                new(){ Text = "Create", Value = 1 },
                new(){ Text = "Delete", Value = 2 },
                new(){ Text = "Sort", Value = 3 }
            }, async e =>
            {
                var content = (Content)args.Value;
                var dbContent = await Mediator.Send(new GetContentCommand { Id = content.Id, IncludeChildren = true });
                //var text = args.Text;
                switch(e.Value)
                {
                    case 1:
                        // Handle Create
                        NavigationManager.NavigateTo($"/admin/createcontent/{content.Id}", forceLoad: true);
                        break;
                    case 2:
                        // Confirm dialogue, say if there are children, and confirm then delete all
                            var hasChildren = dbContent.Children.Any();
                            var message = hasChildren
                                ? "The content you are trying to delete has child content, are you sure you want to delete it?"
                                : "Are you sure you want to delete this?";
                            var delete = await DialogService.Confirm(message, "Delete", new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });
                            if (delete == true)
                            {
                                var result = await Mediator.Send(new DeleteContentCommand{ContentId = dbContent.Id});
                                NotificationService.Notify(new NotificationMessage { 
                                    Severity = result.Success ? NotificationSeverity.Success : NotificationSeverity.Error, 
                                    Summary = result.Success ? "Success" : "Error", 
                                    Detail = result.Messages.MessagesAsString(), Duration = 4000 });
                                if (result.Success)
                                {
                                    StateHasChanged();
                                }
                            }
            
                        break;
                    case 3:
                            if (!dbContent.Children.Any())
                            {
                                // Show message if no children
                                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = "Hmmmm", Detail = "Sorry, nothing to sort as this content has no children", Duration = 4000 });
                            }
                            else
                            {
                                // Show side panel with sorting of children (Can I use a Radzen component?)
                                var result = await DialogService.OpenSideAsync<SortContent>("Sort Children",
                                    new Dictionary<string, object>{ { "ContentId", dbContent.Id }, {"Content", dbContent.Children.OrderBy(x => x.SortOrder).ToList()} },
                                    new SideDialogOptions { CloseDialogOnOverlayClick = true, Position = DialogPosition.Right, ShowMask = true });
        
                                if (result is List<Content> sortedContent)
                                {
                                    var saveResult = await Mediator.Send(new SaveContentCommand {Content = sortedContent});
                                    if (!saveResult.Success)
                                    {
                                        NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = result.Messages.MessagesAsString(), Duration = 4000 });
                                    }
                                    else
                                    {
                                        StateHasChanged();
                                    }
                                }
                            }
         
                        break;
                }
            }
        );
    }

    void OnExpand(TreeExpandEventArgs args)
    {
        if (args.Value is Content category)
        {
            var items = Mediator.Send(new GetContentsCommand
            {
                WhereClause = x => x.ParentId == category.Id,
                OrderBy = GetContentsOrderBy.SortOrder
            }).GetAwaiter().GetResult();
            args.Children.Data = items.Items;
            args.Children.TextProperty = "Name";
            args.Children.Template = context => builder =>
            {
                builder.OpenComponent<RadzenIcon>(0);
                builder.AddAttribute(1, "Icon", (context.Value as Content).ContentType?.Icon);
                builder.AddAttribute(2, "style", "font-weight: 300; color: dimgray;");
                builder.CloseComponent();

                builder.AddContent(3, (context.Value as Content)?.Name);
            };
        }
    }
    
    void OnChange()
    {
        if (Selection is Content content)
        {
            NavigationManager.NavigateTo($"/admin/updatecontent/{content.Id}", forceLoad: true);
        }
    }
}