@page "/"
@page "/{**slug}"
@using ZauberCMS.Core.Content.Commands
@using ZauberCMS.Core.Content.Interfaces
@using ZauberCMS.Core.Plugins
@layout MainLayout

@if (Content != null && ComponentView != null)
{
    <DynamicComponent Type="@ComponentView.GetType()" Parameters="@Parameters" />   
}

@code {
    [Inject] public ExtensionManager ExtensionManager { get; set; } = default!;
    
    [Parameter] public string? Slug { get; set; }
    
    private Content? Content { get; set; }
    private string ViewName { get; set; } = "ZauberCMS.Web.Components.Layout.ContentViews.WebsiteView";
    private Dictionary<string, IContentView> AllContentViews { get; set; } = new();
    private IContentView? ComponentView { get; set; }
    private Dictionary<string, object> Parameters { get; set; } = new();
    
    protected override async Task OnParametersSetAsync()
    {
        AllContentViews = ExtensionManager.GetInstances<IContentView>(true);
        // Do this on parameters set or page won't change
        Content = await Mediator.Send(new GetContentBySlugCommand { Slug = Slug, IsRootContent = Slug == null });
        ComponentView = AllContentViews[ViewName];
        Parameters = new Dictionary<string, object>
        {
            ["Content"] = Content
        };
    }

}